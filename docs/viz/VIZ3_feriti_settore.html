<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafico Feriti per Settore e Regione</title>
    <!-- Styles -->
    <style>
        #chartdiv {
            width: 100%;
            height: 500px;
        }

        #regionSelector {
            font-family: "Poppins", sans-serif;
            font-size: 16px;
            color: #333;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 20px;
            width: 200px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 20px;
            transition: all 0.3s ease;
        }

        #regionSelector:hover {
            border-color: #999;
        }

        #regionSelector:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
    </style>
    
    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <!-- Chart code -->
  <script>
  am5.ready(function() {
  
  // Create root element
  var root = am5.Root.new("chartdiv");
  
  // Set themes
  root.setThemes([am5themes_Animated.new(root)]);
  
  // Create chart
  var chart = root.container.children.push(
    am5xy.XYChart.new(root, {
      panX: true,
      panY: true,
      wheelX: "panX",
      wheelY: "zoomX",
      layout: root.verticalLayout,
      pinchZoomX: true
    })
  );
  
  // Create axes
  var xAxis = chart.xAxes.push(
    am5xy.CategoryAxis.new(root, {
      categoryField: "Year",
      renderer: am5xy.AxisRendererX.new(root, {
        minGridDistance: 30,  // Adjust this value to prevent label overlap
        labelRotation: -45    // Rotate labels if necessary
      }),
      tooltip: am5.Tooltip.new(root, {})
    })
  );
  
  var yAxis = chart.yAxes.push(
    am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    })
  );
  
  // Add legend
  var legend = chart.children.push(am5.Legend.new(root, {
    centerX: am5.p50,
    x: am5.p50
  }));
  
  // Add cursor
  var cursor = chart.set("cursor", am5xy.XYCursor.new(root, {
    behavior: "none"
  }));
  cursor.lineY.set("visible", false);
  
  // Create series for each sector
  var sectors = ["Primario", "Secondario", "Terziario"];
  var seriesMap = {};
  
  sectors.forEach(function(sector) {
    var series = chart.series.push(
      am5xy.LineSeries.new(root, {
        name: sector,
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: sector,
        categoryXField: "Year",
        tooltip: am5.Tooltip.new(root, {
          labelText: "[bold]{name}[/]\nCount: {valueY}\nSummarisedCount: {SummarisedCount}"
        })
      })
    );
  
    series.bullets.push(function() {
      return am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 5,
          fill: series.get("fill")
        })
      });
    });
  
    series.events.on("tooltipshow", function(ev) {
      var dataItem = ev.dataItem;
      if (dataItem) {
        var count = dataItem.get("valueY");
        if (count == 10) {
          ev.tooltip.set("labelText", "[bold]{name}[/]\nCount: <10\nSummarisedCount: {SummarisedCount}");
        } else {
          ev.tooltip.set("labelText", "[bold]{name}[/]\nCount: {valueY}\nSummarisedCount: {SummarisedCount}");
        }
      }
    });
  
    seriesMap[sector] = series;
  });
  
  // Add scrollbar
  chart.set("scrollbarX", am5.Scrollbar.new(root, {
    orientation: "horizontal"
  }));
  
  // Create a dropdown for Region selection
  var regionSelector = document.createElement("select");
  regionSelector.id = "regionSelector";
  var regions = ["Abruzzo", "Basilicata", "Calabria", "Campania", "Emilia Romagna", "Friuli Venezia Giulia","Lazio","Liguria","Lombardia","Marche","Molise","Piemonte","Puglia","Sardegna","Sicilia","Toscana","Trentino Alto Adige","Umbria","Valle D'Aosta","Veneto"]; // Adjust based on your CSV data
  regions.forEach(function(region) {
    var option = document.createElement("option");
    option.value = region;
    option.text = region;
    regionSelector.appendChild(option);
  });
  
  document.body.insertBefore(regionSelector, document.getElementById("chartdiv"));
  
  // Load CSV data
  d3.csv("./summarised-tables/summarised_feriti_settore.csv").then(function(csvData) {
    console.log("CSV data loaded:", csvData);
    if (csvData.length === 0) {
      console.error("No data loaded from CSV");
      return;
    }

    // Function to update the chart data
    function updateChartData(selectedRegion) {
      var filteredData = csvData.filter(function(item) {
        return item["DescrRegione"] === selectedRegion;
      });
      console.log("Filtered data:", filteredData);

      var chartData = {};
      filteredData.forEach(function(item) {
        if (!chartData[item.Year]) {
          chartData[item.Year] = { Year: item.Year };
        }
        chartData[item.Year][item.Settore] = parseInt(item["Count"], 10);
        chartData[item.Year]["SummarisedCount"] = item["SummarisedCount"];
      });
      console.log("Chart data:", chartData);

      var finalData = Object.values(chartData);
      console.log("Final data:", finalData);

      xAxis.data.setAll(finalData);
      sectors.forEach(function(sector) {
        var seriesData = finalData.map(function(item) {
          return {
            Year: item.Year,
            [sector]: item[sector] || 0,
            SummarisedCount: item["SummarisedCount"]
          };
        });
        console.log("Series data for " + sector + ":", seriesData);
        seriesMap[sector].data.setAll(seriesData);
      });
    }
  
    // Event listener for dropdown change
    regionSelector.addEventListener("change", function() {
      updateChartData(this.value);
    });
  
    // Initial chart update
    updateChartData("Abruzzo");

    // Highlight range for the years 2020, 2021, and 2022
    chart.events.on("datavalidated", function(ev) {
      var range = xAxis.createAxisRange(xAxis.makeDataItem({}));
        range.set("value", new Date(2020, 6, 1).getTime());  // 1 luglio 2020
        range.set("endValue", new Date(2022, 6, 1).getTime());  // 1 luglio 2022
        
        range.get("axisFill").setAll({
          fill: am5.color("#396478"),
          fillOpacity: 0.2,
          visible: true
        });
        
        range.get("grid").setAll({
          strokeOpacity: 0
        });
      });

      // Imposta la posizione di inizio e fine
      range.set("location", 0.5);  // Inizia a metà del 2020
      range.set("endLocation", 0.5);  // Termina a metà del 2022
    });

    console.log("Series map:", seriesMap);
      }).catch(function(error) {
        console.error("Error loading CSV:", error);
  });

  </script>
  
  <!-- HTML -->
  <div id="chartdiv"></div>
</body>
</html>